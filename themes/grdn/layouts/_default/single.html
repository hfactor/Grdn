{{ define "main" }}
<div class="note-container">
  <article class="note-content">
    <h1>{{ .Title }}</h1>
    
    <div class="note-metadata">
      {{ if .Params.category }}
      <div class="metadata">
        <span class="category">{{ .Params.category }}</span>
        {{ if .Params.growth }}
        <span class="growth">{{ .Params.growth }}</span>
        {{ end }}
      </div>
      {{ end }}
    </div>

    <div class="content">
      {{ $content := .RawContent }}
      {{ $wikilinks := findRE `\[\[(.*?)\]\]` $content -1 }}
      
      {{ range $wikilinks }}
        {{ $original := . }}
        {{ $inner := strings.TrimPrefix "[[" (strings.TrimSuffix "]]" $original) }}
        
        {{ $target := $inner }}
        {{ $display := $inner }}
        
        {{ if strings.Contains $inner "|" }}
          {{ $parts := split $inner "|" }}
          {{ $target = trim (index $parts 0) " " }}
          {{ $display = trim (index $parts 1) " " }}
        {{ end }}
        
        {{ $found := false }}
        {{ $matchedPage := "" }}
        
        <!-- Try filename match first -->
        {{ range where $.Site.RegularPages "Section" "notes" }}
          {{ $filename := .File.BaseFileName }}
          {{ $normalizedTarget := $target }}
          
          <!-- Handle both space and hyphen variations -->
          {{ $filename = replace $filename "-" " " }}
          {{ if strings.Contains $target "-" }}
            {{ $normalizedTarget = replace $target "-" " " }}
          {{ end }}
          
          {{ if eq (lower $filename) (lower $normalizedTarget) }}
            {{ $found = true }}
            {{ $matchedPage = . }}
          {{ end }}
        {{ end }}
        
        <!-- Then try alias match -->
        {{ if not $found }}
          {{ range where $.Site.RegularPages "Section" "notes" }}
            {{ with .Params.aliases }}
              {{ range . }}
                {{ if eq (lower (trim . " ")) (lower $target) }}
                  {{ $found = true }}
                  {{ $matchedPage = $.Page }}
                {{ end }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
        
        {{ $replacement := "" }}
        {{ if $found }}
          {{ $replacement = printf `<a href="%s" class="wikilink">%s</a>` 
            $matchedPage.RelPermalink 
            $display
          }}
        {{ else }}
          {{ $replacement = printf `<span class="wikilink broken" title="%s">%s</span>` 
            $.Site.Params.wikilinks.brokenLinkTooltip 
            $display 
          }}
        {{ end }}
        
        {{ $content = replace $content $original $replacement }}
      {{ end }}
      
      {{ $content | markdownify }}
    </div>
    
    <div class="note-footer">
      {{ partial "backlinks.html" . }}
    </div>
  </article>
</div>
{{ end }}
